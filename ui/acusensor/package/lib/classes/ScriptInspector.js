"use strict";function asyncGeneratorStep(e,t,r,s,o,i,n){try{var a=e[i](n),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(s,o)}function _asyncToGenerator(e){return function(){var t=this,r=arguments;return new Promise((function(s,o){var i=e.apply(t,r);function n(e){asyncGeneratorStep(i,s,o,n,a,"next",e)}function a(e){asyncGeneratorStep(i,s,o,n,a,"throw",e)}n(void 0)}))}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r={}.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,s=Array(t);r<t;r++)s[r]=e[r];return s}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var s,o,i,n,a=[],c=!0,l=!1;try{if(i=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(s=i.call(r)).done)&&(a.push(s.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=r.return&&(n=r.return(),Object(n)!==n))return}finally{if(l)throw o}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,s)}return r}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}const EventEmitter=require("events"),Log=require("./Logger").logger("inspector");Log.on("message",Log.output.stdout.full);const _require=require("child_process"),spawn=_require.spawn,fs=require("fs"),path=require("path"),HeaderSensorEnabled="acunetix-aspect",HeaderSensorQueries="acunetix-aspect-queries",HeaderSensorPassword="acunetix-aspect-password",HeaderScanID="acunetix-aspect-scanid",HooksFileName="hooks.js",DiscoveryType=Object.freeze({File_Open:"File_Open",File_Write:"File_Open",File_Move:"File_Open",File_Copy:"File_Open",File_Delete:"File_Open",SQL_Query:"SQL_Query",Send_Mail:"Send_Mail",Sys_Command:"Sys_Command",Url_Open:"Url_Open",Template_Render:"Template_Render",XML_Parse:"XML_Parse",MongoDB_Query:"MongoDB_Query",LDAP_Query:"LDAP_Query"}),log=Object.freeze({info:(...e)=>{Log.info(...e)},warn:(...e)=>{Log.warn(...e)},debug:(...e)=>{Log.debug(...e)},error:(...e)=>{Log.error(...e)}}),getDirItems=e=>{let t=[];try{t=fs.readdirSync(e)}catch(e){}return t},safeFileExists=e=>{let t=!1;try{t=fs.existsSync(e)}catch(e){}return t};class ScriptInspector extends EventEmitter{constructor({nodeExecutable:e,scriptPath:t,scriptArgs:r=[],customHooks:s=[]}){super(),this._nodeExecutable=e,this._scriptPath=t,this._scriptArgs=r,this._checkedModulePaths=new Set,this._discoveredFiles=new Set,this._discoveredRoutes=new Set,this._discoveredModules=new Set,this._declaredModules=new Set,this._applicationConfig={},"development"===process.env.NODE_ENV&&(this._applicationConfig.express_dev_mode=!0),process.nextTick((()=>{log.info("Launching Node Process.."),this._launch((()=>{log.info("Process launched."),this.emit("ready")}))}))}_emitDiscovery(e,t,r,s){const o=[];s&&o.push(s),r.stack&&o.push(r.stack),this.emit("discovery",{type:e,data:t,location:r,additional:o})}_isValidRoute(e){return e.startsWith("/")}_handleLDAPDiscovery(e,t){this._emitDiscovery(DiscoveryType.LDAP_Query,e.filter,t)}_handleNoSQLDiscovery(e,t){if("mongodb"!==e.engine)return!1;let r;try{r=JSON.stringify(e.query)}catch(e){return!1}this._emitDiscovery(DiscoveryType.MongoDB_Query,r,t,`databasename=${e.database}; collection=${e.collection}; method=${e.method}`)}_handleSQLDiscovery(e,t){this._emitDiscovery(DiscoveryType.SQL_Query,e.sql,t,`database=${e.engine}`)}_handleTemplateMarkup({markup:e},t){this._emitDiscovery(DiscoveryType.Template_Render,e,t)}_handleXMLParser({markup:e},t){this._emitDiscovery(DiscoveryType.XML_Parse,e,t)}_handleConfigurationDiscovery(e,t){Object.assign(this._applicationConfig,e)}_handleRouteDiscovery(e,t){const r=e.route,s=e.framework;if(!this._isValidRoute(r))return!1;"express-static"!==s?(this.emit("route",r,t),this._discoveredRoutes.add(e)):this._discoveredFiles.add(r)}_handleIncomingHTTPRequest(e,t){if("incoming"!==e.direction)return!1;const r=e.request,s=r.url,o=r.method,i=r.headers;this.emit("httprequest",`${o} ${s}`,t);let n=!1;const a=[];"object"==typeof i&&(i["acunetix-aspect"]&&(n=!0),"string"==typeof i[HeaderScanID]&&(n=!0,this.emit("scanid",i[HeaderScanID])),"string"==typeof i[HeaderSensorPassword]&&(n=!0,this.emit("sensorpassword",i[HeaderSensorPassword])),"string"==typeof i[HeaderSensorQueries]&&(n=!0,i[HeaderSensorQueries].length<500?i[HeaderSensorQueries].split(";").forEach((e=>{a.push(e.trim())})):log.warn(`${HeaderSensorQueries} header ignored as it exceeds max size (${i[HeaderSensorQueries].length} bytes)`))),n&&this.emit("sensorrequest"),a.forEach((e=>{this.emit("sensorquery",e)}))}_handleOutgoingHTTPRequest(e,t){if("outgoing"!==e.direction)return!1;this._emitDiscovery(DiscoveryType.Url_Open,e.request.url,t)}_handleHTTPRequest(e,t){return!!e.request&&("incoming"===e.direction?this._handleIncomingHTTPRequest(e,t):this._handleOutgoingHTTPRequest(e,t))}_handleMailDiscovery(e,t){const r=[e.to,e.subject];this._emitDiscovery(DiscoveryType.Send_Mail,r,t)}_handleSysCommandDiscovery(e,t){const r=e.args;this._emitDiscovery(DiscoveryType.Sys_Command,r[0],t)}_handleFSDiscovery(e,t){const r=e.args;if(t&&t.path&&(t.path.startsWith("internal/")||"fs.js"===t.path))return!1;switch(e.method){case"unlink":case"unlinkSync":this._emitDiscovery(DiscoveryType.File_Delete,r[0],t);break;case"open":case"openSync":case"readFile":case"readFileSync":case"createReadStream":this._emitDiscovery(DiscoveryType.File_Open,r[0],t);break;case"writeFile":case"writeFileSync":case"appendFile":case"appendFileSync":case"createWriteStream":this._emitDiscovery(DiscoveryType.File_Write,r[0],t);break;case"rename":case"renameSync":this._emitDiscovery(DiscoveryType.File_Move,`${r[0]} - ${r[1]}`,t);break;case"copyFile":case"copyFileSync":this._emitDiscovery(DiscoveryType.File_Copy,`${r[0]} - ${r[1]}`,t)}}_getHookedPackages(){return Object.keys(this._getHookedPackagesDetails())}_getHookedPackagesDetails(){const e=path.join(__dirname,"..","hooks"),t=fs.readdirSync(e),r={};return t.forEach((t=>{if(!t.endsWith(".js"))return!1;const s=path.join(e,t),o=require(s),i=o.hook,n=o.packageNames;if(!(n&&n instanceof Array))return!1;n.forEach((e=>{r[e]={hook:i}}))})),r}_findDeclaredModules(e){const t=require("module").Module;if(!t||"function"!=typeof t._nodeModulePaths)return;const r=t._nodeModulePaths(path.dirname(e));if(!(r instanceof Array))return;let s=null;for(let e=0;e<r.length;e++){const t=r[e].split(path.sep);t.pop();const o=t.join(path.sep)+path.sep+"package-lock.json";if(safeFileExists(o)){log.info("Found package-lock.json at",o),s=o;break}}let o=null;for(let e=0;e<r.length;e++){const t=r[e];try{if(fs.existsSync(t)){o=t,log.info("Found node_modules folder",o);break}}catch(e){}}let i=new Set;if(s&&(i=this._extractModulesFromPackageLock(s)),o){const e=[];e.push(o);let t=0;for(;0!==e.length;){if(t++,t>1e4){log.error("node_modules recursive walk limit exhausted");break}const r=e.shift(),s=getDirItems(r);for(let t=0;t<s.length;t++){const o=path.join(r,s[t]),n=path.join(o,"package.json"),a=path.join(o,"node_modules");if(safeFileExists(n))try{const e=require(n),t=e.name,r=e.version;t&&r&&i.add(`${t}@${r}`)}catch(e){}safeFileExists(a)&&e.push(a)}}}this._declaredModules=i}_extractModulesFromPackageJSON(e){const t={};let r=null;try{r=JSON.parse(fs.readFileSync(e))}catch(e){}if(r&&"object"==typeof r.dependencies)for(let e in r.dependencies){let s=r.dependencies[e];if("string"!=typeof s)continue;const o=s.charAt(0);parseInt(o,10)+""===o||(s=s.substr(1)),t[e]=s}return t}_extractModulesFromPackageLock(e){const t=new Set;let r=null;try{r=JSON.parse(fs.readFileSync(e))}catch(e){}const s=[];r&&"object"==typeof r.dependencies&&s.push(r.dependencies);let o=0;for(;0!==s.length;){if(o++,o>1e4){log.error("dependency recursive walk limit exhausted");break}const e=s.shift();for(let r in e){const o=e[r];o.dependencies&&s.push(o.dependencies),"object"==typeof o&&"string"==typeof o.version&&t.add(`${r}@${o.version}`)}}return t}_checkIfModuleLoader(e,t=""){if(!e)return!1;if(this._checkedModulePaths.has(e))return!1;this._checkedModulePaths.add(e);let r={path:"",line:0};const s=t.split("\n");for(let e=2;e<s.length;e++){const t=s[e].trim(),o=this._extractLocationFromStackLine(t);if(!o||!o.path||!o.path.startsWith("internal/")&&!o.path.includes("hooks.js")){r=o;break}}let o=path.dirname(e);if(!o.includes(`${path.sep}node_modules`))return!1;this._findPackageJSON(o,(e=>{e&&this._emitModuleLoaded(e,r)}))}_findPackageJSON(e,t=(()=>{})){const r=path.join(e,"package.json");fs.stat(r,((s,o)=>{if(!s&&o.isFile())return t(r);const i=e.split(path.sep);i.pop();if("node_modules"===i[i.length-1])return t(null);this._findPackageJSON(i.join(path.sep),t)}))}_emitModuleLoaded(e,t){const r=require(e),s=r.name,o=r.version;if(!s||!o)return!1;const i=`${s}@${o}`;if(this._discoveredModules.has(i))return!1;this._discoveredModules.add(i),this.emit("moduleloaded",{name:s,version:o},t)}_extractLocationFromStackLine(e){let t=e.indexOf(" ("),r=null;-1!==t?(t+=2,r=e.substring(t,e.length-1)):r=e.trim().substring(3);const s=r.lastIndexOf(":"),o=r.lastIndexOf(":",s-1),i=parseInt(r.substr(o+1),10);let n=r.substr(0,o);return n.startsWith("file:///")&&(n=n.substr(8)),{path:path.join(n),line:i}}_extractLineFromStack(e,t){const r=e.split("\n")[t];return r?this._extractLocationFromStackLine(r):{}}_processMessage(e){const t=e.hook,r=e.data,s=e.stack,o=e.firstUserLineIndex;if(!t||!r)return!1;let i={};switch(s&&(i=this._extractLineFromStack(s,o)),e.userStack&&(isNaN(i.line)&&(i=this._extractLocationFromStackLine(e.userStack[0])),i.stack=e.userStack.join("\n")),t){case"core.require":this._checkIfModuleLoader(r.path,s);break;case"core.fs":"openSync"===r.method&&this._checkIfModuleLoader(r.args[0]),this._handleFSDiscovery(r,i);break;case"core.child_process":this._handleSysCommandDiscovery(r,i);break;case"sendmail":this._handleMailDiscovery(r,i);break;case"route":this._handleRouteDiscovery(r,i);break;case"sql":this._handleSQLDiscovery(r,i);break;case"httprequest":this._handleHTTPRequest(r,i);break;case"configuration":this._handleConfigurationDiscovery(r,i);break;case"template":this._handleTemplateMarkup(r,i);break;case"xmlparser":this._handleXMLParser(r,i);break;case"nosql":this._handleNoSQLDiscovery(r,i);break;case"ldapquery":this._handleLDAPDiscovery(r,i)}}_launch(e){log.info("Node Executable",this._nodeExecutable);const t=path.join(__dirname,"..","hooks.js");let r=process.cwd();r=path.resolve(r);const s={};Object.assign(s,process.env);const o=r.split(path.sep);for(;0!==o.length;){const e=path.join(o.join(path.sep),"node_modules");try{if(fs.statSync(e).isDirectory()){s.NODE_PATH=e,log.info(`NODE_PATH set to ${e}`);break}}catch(e){}o.pop()}this._findDeclaredModules(this._scriptPath);const i=_objectSpread({},s),n=this._getHookedPackages(),a=this.getAllKnownModuleNames(),c=new Set;a.forEach((e=>{n.includes(e)&&c.add(e)})),i._seenhookpackages=JSON.stringify(Array.from(c));const l=spawn(this._nodeExecutable,["--require",t,this._scriptPath,...this._scriptArgs],{stdio:["pipe","pipe","pipe","ipc"],env:i});l.on("message",(e=>{if("object"!=typeof e)return!1;this._processMessage(e)})),l.stdout.on("data",(e=>{process.stdout.write(e)})),l.stderr.on("data",(e=>{process.stderr.write(e)})),e()}getAllKnownModuleNames(){const e=this.getAllKnownModules(),t=new Set;return e.forEach((e=>{const r=_slicedToArray(e.split("@"),1)[0];t.add(r)})),Array.from(t)}getAllKnownModules(){const e=[],t=Array.from(this.getDiscoveredModules()),r=Array.from(this.getDeclaredModules());return t.forEach((t=>{e.push(t)})),r.forEach((t=>{if(e.includes(t))return!1;e.push(t)})),e}getDiscoveredPaths(){const e=new Set;return this.getDiscoveredRoutes().forEach((({route:t})=>{e.add(t)})),this._discoveredFiles.forEach((t=>{e.add(t)})),Array.from(e)}getDiscoveredRoutes(){return Array.from(this._discoveredRoutes)}getGroupedRoutes(){const e={};return this.getDiscoveredRoutes().forEach((({route:t,method:r,framework:s})=>{e[s]=e[s]||[];const o=`${r} ${t}`;e[s].includes(o)||e[s].push(o)})),e}getDiscoveredModules(){return this._discoveredModules}getDeclaredModules(){return this._declaredModules}getDiscoveredConfig(){const e=[],t=this._applicationConfig,r=t.has_node_exception_handler,s=t.has_node_rejection_handler,o=t.express_session_secret,i=t.express_dev_mode;return r||e.push("missing_node_exception_handler=true"),s||e.push("missing_node_rejection_handler=true"),"string"==typeof o&&e.push(`express_session_secret=${o}`),i&&e.push("express_dev_mode=true"),e}getKnownWebServers(){const e=this._getHookedPackagesDetails(),t=[];for(let s in e){var r;((null===(r=e[s])||void 0===r?void 0:r.hook)||[]).includes("route")&&t.push(s)}return t}}exports.create=_asyncToGenerator((function*(...e){log.debug("creating inspector instance");const t=new ScriptInspector(...e);return new Promise((e=>{t.on("ready",_asyncToGenerator((function*(){log.debug("inspector ready"),e(t)})))}))}));