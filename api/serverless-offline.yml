service: ${file(./serverless-config-default.yml):service}

frameworkVersion: ${file(./serverless-config-default.yml):frameworkVersion}

useDotenv: ${file(./serverless-config-default.yml):useDotenv}

plugins:
    - serverless-offline-ssm
    - serverless-offline
    - serverless-webpack
    - serverless-webpack-prisma

provider:
    name: aws
    deploymentMethod: direct
    timeout: 30
    runtime: nodejs18.x
    region: eu-west-1
    stage: 'local'
    deploymentBucket:
        tags:
            Project: Octopus
            Owner: 0 - 3 Years Innovation Team
            Name: Octopus API
    iamRoleStatements:
        - Effect: 'Allow'
          Action:
              - 'lambda:InvokeFunction'
              - 'ses:SendEmail'
              - 'ses:SendRawEmail'
          Resource: '*'
        - Effect: 'Allow'
          Resource: 'arn:aws:s3:::science-octopus-publishing-images-${self:provider.stage}/*'
          Action: 's3:PutObject'
        - Effect: 'Allow'
          Resource: 'arn:aws:s3:::science-octopus-publishing-pdfs-${self:provider.stage}/*'
          Action: 's3:PutObject'
        - Effect: 'Allow'
          Resource: 'arn:aws:s3:::science-octopus-publishing-sitemaps-${self:provider.stage}/*'
          Action: 's3:PutObject'
        - Effect: 'Allow'
          Resource: 'arn:aws:s3:::science-octopus-publishing-sitemaps-${self:provider.stage}'
          Action: 's3:ListBucket'
custom:
    webpack:
        webpackConfig: ./webpack.config.js
        includeModules:
            forceExclude:
                - '@aws-sdk/client-s3'
                - '@aws-sdk/client-ses'
                - '@aws-sdk/client-sqs'
                - 'puppeteer'
                - 'prisma'
        packager: 'npm'
    versions:
        v1: v1
    serverless-offline:
        useChildProcesses: true
    serverless-offline-ssm:
        stages:
            - local
        ssm:
            /local_octopus_sls_sg: '1'
            /local_octopus_private_subnet_az1: '1'
            /local_octopus_private_subnet_az2: '2'
            /local_octopus_private_subnet_az3: '3'
            /elasticsearch_user_local_octopus: ${env:ELASTICSEARCH_USER}
            /elasticsearch_password_local_octopus: ${env:ELASTICSEARCH_PASSWORD}
            /elasticsearch_endpoint_local_octopus: ${env:ELASTICSEARCH_ENDPOINT}
            /elastic_search_protocol_local_octopus: ${env:ELASTICSEARCH_PROTOCOL}
            /db_connection_string_local_octopus: ${env:DATABASE_URL}
            /jwt_secret_local_octopus: ${env:JWT_SECRET}
            /orcid_secret_key_local_octopus: ${env:ORCID_SECRET}
            /orcid_app_id_local_octopus: ${env:ORCID_ID}
            /orcid_auth_url_local_octopus: ${env:ORCID_AUTH_URL}
            /orcid_member_api_url_local_octopus: ${env:ORCID_MEMBER_API_URL}
            /doi_prefix_local_octopus: ${env:DOI_PREFIX}
            /datacite_endpoint_local_octopus: ${env:DATACITE_ENDPOINT}
            /datacite_user_local_octopus: ${env:DATACITE_USER}
            /datacite_password_local_octopus: ${env:DATACITE_PASSWORD}
            /email_sender_address_local_octopus: ${env:EMAIL_SENDER_ADDRESS}
            /base_url_local_octopus: ${env:BASE_URL}
            /authorization_callback_url_local_octopus: ${env:AUTHORISATION_CALLBACK_URL}
            /list_users_api_key_local_octopus: ${env:LIST_USERS_API_KEY}
            /queue_url_local_octopus: ${env:QUEUE_URL}
            /sqs_endpoint_local_octopus: ${env:SQS_ENDPOINT}
            /mail_server_local_octopus: ${env:MAIL_SERVER}
functions:
    - ${file(./serverless-config-default.yml):functions}